<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Video Poker - Game Verification Script</title>
    <link rel="stylesheet" href="./styles/bootstrap.min.css" />
    <script src="./scripts/vue.min.js"></script>
    <script src="./scripts/crypto-js.js"></script>
    <style>
      body {
        overflow-y: scroll;
      }
      .main {
        max-width: 800px;
        width: 100%;
        margin: 50px auto;
        padding: 0 10px;
        box-sizing: border-box;
      }
      .success {
        background-color: rgba(0, 255, 0, 0.3);
      }
      .error {
        background-color: rgba(255, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div id="app" class="main">
      <h1 class="text-center mb-4">Video Poker - Game Verification Script</h1>

      <hr />

      <form class="my-5">
        <h2 class="text-center">Input</h2>

        <div class="mb-3">
          <label class="form-label" for="client-seed">Client seed</label>
          <input
            id="client-seed"
            placeholder="Client seed"
            v-model="clientSeed"
            class="form-control"
          />
        </div>

        <div class="mb-3">
          <label class="form-label" for="server-seed">Server seed</label>
          <input
            id="server-seed"
            placeholder="Server seed"
            v-model="serverSeed"
            class="form-control"
          />
        </div>

        <div class="mb-3">
          <label class="form-label" for="nonce">Nonce</label>
          <input
            id="nonce"
            placeholder="Nonce"
            v-model="nonce"
            class="form-control"
          />
        </div>
      </form>

      <div v-if="isOutputShowed">
        <form class="my-5">
          <h2 class="text-center mb-4">Output</h2>

          <div class="mb-3">
            <label class="form-label">sha256 (result)</label>
            <input
              :value="resultHash"
              readonly="readonly"
              class="form-control"
              v-bind:class="{success: resultHash == verification, error: resultHash != verification}"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">sha256 (server seed)</label>
            <input
              :value="calculatedServerSeedHash"
              readonly="readonly"
              class="form-control"
              v-bind:class="{success: calculatedServerSeedHash == serverSeedHash, error: calculatedServerSeedHash != serverSeedHash}"
            />
          </div>
        </form>

        <div class="my-5">
          <h2 class="text-center mb-4">Results</h2>
          <div class="row mb-4">
            <div class="col-6">
              <h3 class="mb-0">First deal</h3>
              <div class="display-1">
                {{progressCards}}
              </div>
            </div>
            <div class="col-6">
              <h3 class="mb-0">Second deal</h3>
              <div class="display-1">
                {{resultCards}}
              </div>
            </div>
          </div>
          
          <div class="col-12 mt-15">
            <h3 class="mb-0">Shuffled deck</h3>
            <div class="display-1">
              {{shuffledCards}}
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const SALT = "video-poker-a8fcbe86-ad26-439f-bed9-1728234166e4";

      function queryString() {
        return window.location.search
          .replace("?", "")
          .split("&")
          .reduce(function (res, item) {
            let kv = item.split("=");
            res[kv[0]] = kv[1];
            return res;
          }, {});
      }

      const qs = queryString();

      const app = Vue.createApp({
        data() {
          return {
            clientSeed: qs.c || "",
            serverSeed: qs.s || "",
            serverSeedHash: qs.h || "",
            nonce: qs.n || "",
            verification: qs.v || "",
            progressData: qs.p || "",
            resultData: qs.r || "",
            cards: "ðŸ‚¡ðŸ‚¢ðŸ‚£ðŸ‚¤ðŸ‚¥ðŸ‚¦ðŸ‚§ðŸ‚¨ðŸ‚©ðŸ‚ªðŸ‚«ðŸ‚­ðŸ‚®ðŸƒ‘ðŸƒ’ðŸƒ“ðŸƒ”ðŸƒ•ðŸƒ–ðŸƒ—ðŸƒ˜ðŸƒ™ðŸƒšðŸƒ›ðŸƒðŸƒžðŸƒðŸƒ‚ðŸƒƒðŸƒ„ðŸƒ…ðŸƒ†ðŸƒ‡ðŸƒˆðŸƒ‰ðŸƒŠðŸƒ‹ðŸƒðŸƒŽðŸ‚±ðŸ‚²ðŸ‚³ðŸ‚´ðŸ‚µðŸ‚¶ðŸ‚·ðŸ‚¸ðŸ‚¹ðŸ‚ºðŸ‚»ðŸ‚½ðŸ‚¾",
            beginIndex: 0,
            extendedHash: qs.v || "",
            cardsTextCodeMap: {
              'AS': 'ðŸ‚¡',
              '2S': 'ðŸ‚¢',
              '3S': 'ðŸ‚£',
              '4S': 'ðŸ‚¤',
              '5S': 'ðŸ‚¥',
              '6S': 'ðŸ‚¦',
              '7S': 'ðŸ‚§',
              '8S': 'ðŸ‚¨',
              '9S': 'ðŸ‚©',
              '0S': 'ðŸ‚ª',
              'JS': 'ðŸ‚«',
              'QS': 'ðŸ‚­',
              'KS': 'ðŸ‚®',
              'AC': 'ðŸƒ‘',
              '2C': 'ðŸƒ’',
              '3C': 'ðŸƒ“',
              '4C': 'ðŸƒ”',
              '5C': 'ðŸƒ•',
              '6C': 'ðŸƒ–',
              '7C': 'ðŸƒ—',
              '8C': 'ðŸƒ˜',
              '9C': 'ðŸƒ™',
              '0C': 'ðŸƒš',
              'JC': 'ðŸƒ›',
              'QC': 'ðŸƒ',
              'KC': 'ðŸƒž',
              'AD': 'ðŸƒ',
              '2D': 'ðŸƒ‚',
              '3D': 'ðŸƒƒ',
              '4D': 'ðŸƒ„',
              '5D': 'ðŸƒ…',
              '6D': 'ðŸƒ†',
              '7D': 'ðŸƒ‡',
              '8D': 'ðŸƒˆ',
              '9D': 'ðŸƒ‰',
              '0D': 'ðŸƒŠ',
              'JD': 'ðŸƒ‹',
              'QD': 'ðŸƒ',
              'KD': 'ðŸƒŽ',
              'AH': 'ðŸ‚±',
              '2H': 'ðŸ‚²',
              '3H': 'ðŸ‚³',
              '4H': 'ðŸ‚´',
              '5H': 'ðŸ‚µ',
              '6H': 'ðŸ‚¶',
              '7H': 'ðŸ‚·',
              '8H': 'ðŸ‚¸',
              '9H': 'ðŸ‚¹',
              '0H': 'ðŸ‚º',
              'JH': 'ðŸ‚»',
              'QH': 'ðŸ‚½',
              'KH': 'ðŸ‚¾',
            }
          };
        },
        computed: {
          isOutputShowed() {
            return this.clientSeed && this.serverSeed && this.nonce;
          },
          resultHash() {
            return CryptoJS.SHA256(
              this.serverSeed + this.clientSeed + this.nonce
            );
          },
          calculatedServerSeedHash() {
            return CryptoJS.SHA256(this.serverSeed + SALT);
          },
          progressCards() {
            return this.progressData.match(/.{1,2}/g)?.map((code) => this.cardsTextCodeMap[code]).join("");
          },
          resultCards() {
            return this.resultData.match(/.{1,2}/g)?.map((code) => this.cardsTextCodeMap[code]).join("");
          },
          shuffledCards() {
            const shuffled = this.getCards(this.resultHash)
            return shuffled;
          }
        },
        methods: {
          parseInt(value) {
            return window.parseInt(value, 16);
          },
          getCards() {
            let arr = Array.from(this.cards);
            this.shuffle(arr);
            return arr.join("");
          },

          // Pseudo-random number generator (based on the hash)
          nextInt(bound) {
            const symbolsPerResult = Math.ceil(
              Math.log(bound * 10000) / Math.log(16)
            );
            const divider = BigInt(1) << BigInt(symbolsPerResult * 4);

            const endIndex = this.beginIndex + symbolsPerResult;
            if (endIndex > this.extendedHash.length) {
              this.extendedHash += CryptoJS.SHA256(this.extendedHash);
            }

            const substring = this.extendedHash.substring(
              this.beginIndex,
              endIndex
            );
            this.beginIndex = endIndex;
            const randomNumber = BigInt("0x" + substring);
            const result = (randomNumber * BigInt(bound)) / divider;
            return Number(result);
          },

          // Shuffle algorithm
          shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
              let j = this.nextInt(i + 1);
              [arr[i], arr[j]] = [arr[j], arr[i]];
            }
          },
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
